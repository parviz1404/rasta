<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoCalc — محاسبه‌گر گمانه/چاهک/آزمایش برجا (V7)</title>
  <style>
    :root{
      --bg:#f6f8fc; --fg:#0b1020; --muted:#6b7280;
      --primary:#2563eb; --primary-2:#60a5fa;
      --tint1:#eef4ff; --tint2:#ffffff; --tint3:#fafcff;
      --border:#e6e8ef;
      --shadow:0 18px 44px rgba(2,6,23,.08);
      --shadow2:0 10px 24px rgba(2,6,23,.06);
      --r-lg:18px; --r-md:12px; --r-xl:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1100px 520px at 110% -10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 520px at -10% 120%, rgba(125,211,252,.14), transparent 60%),
        var(--bg);
      color:var(--fg);
      font:16px/1.7 "Vazirmatn","IRANSans",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    header{
      background:linear-gradient(120deg,var(--primary),var(--primary-2));
      color:#fff; padding:18px 20px; box-shadow:var(--shadow)
    }
    header h1{margin:0; font-size:20px; font-weight:900}
    .wrap{max-width:1100px; margin:22px auto; padding:0 16px}

    .grid{display:grid; gap:18px; grid-template-columns:1.05fr .95fr}
    @media (max-width:990px){.grid{grid-template-columns:1fr}}

    .section{border:1px solid var(--border); border-radius:var(--r-xl); overflow:hidden; box-shadow:var(--shadow); background:#fff}
    .sec-header{display:flex; gap:10px; align-items:center; padding:12px 16px; background:linear-gradient(180deg,#fff,#f9fbff); border-bottom:1px solid var(--border)}
    .sec-title{margin:0; font-size:17px; font-weight:900; color:#111827}
    .sec-body{padding:16px}
    .sec-inputs{background:var(--tint1)}
    .sec-results{background:var(--tint2)}
    .sec-table{background:var(--tint3)}

    .inputs{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(220px,1fr))}
    @media (max-width:700px){.inputs{grid-template-columns:1fr}}
    label{display:block; font-size:12px; font-weight:800; color:#334155; margin:6px 2px}
    .control{display:flex; align-items:center; gap:10px; background:#f8fbff; border:1px solid var(--border); border-radius:var(--r-md); padding:10px 12px; box-shadow:inset 0 2px 6px rgba(0,0,0,.04)}
    input{width:100%; border:0; outline:0; background:transparent; font-weight:800; color:#0b1020; direction:ltr; text-align:right}
    .suffix{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px}
    .btn{padding:10px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:900; background:linear-gradient(120deg,#3b82f6,#60a5fa); color:#fff; box-shadow:0 10px 22px rgba(59,130,246,.25)}
    .btn-outline{background:#fff; color:var(--primary); border:2px solid var(--primary); box-shadow:none}
    .note{font-size:12px; color:var(--muted)}
    .err{display:none; margin-top:6px; color:#ef4444; font-size:13px}

    .cards{display:grid; gap:12px; grid-template-columns:repeat(3,minmax(180px,1fr))}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,minmax(180px,1fr))}}
    @media (max-width:600px){.cards{grid-template-columns:1fr}}
    .card{border:1px solid var(--border); border-radius:16px; background:#fff; padding:14px; box-shadow:var(--shadow2)}
    .k{font-size:12px; color:var(--muted)} .v{font-size:24px; font-weight:900; color:var(--fg); margin-top:4px}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; background:#eff6ff; border:1px solid #dbeafe; color:#1d4ed8; font-size:12px}

    /* جدول: جلوگیری از بیرون‌زدن اعداد در موبایل */
    .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:16px; border:1px solid var(--border); background:#fff; box-shadow:var(--shadow2)}
    table{width:100%; border-collapse:collapse; min-width:680px; table-layout:fixed}
    th,td{padding:12px; border-bottom:1px solid var(--border); text-align:center; overflow-wrap:anywhere; word-break:break-word}
    th{background:#f7f9ff; color:#374151; font-size:13px}
    td:nth-child(2){direction:ltr; text-align:left; white-space:nowrap;} /* ستون مقدار */

    footer{margin:22px auto 28px; max-width:1100px; padding:14px 16px; background:#fff; border:1px dashed #c7d2fe; color:#1f2937; border-radius:16px; box-shadow:var(--shadow2); line-height:1.8; font-size:13px}
    footer strong{font-weight:900}
  </style>
</head>
<body>
  <header><div class="wrap"><h1>GeoCalc — محاسبه‌گر گمانه / چاهک گود / آزمایشات برجا (V7)</h1></div></header>

  <main class="wrap">
    <div class="grid">
      <!-- Inputs -->
      <section class="section sec-inputs">
        <div class="sec-header">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16M4 12h10M4 17h16" stroke="#334155" stroke-width="2" stroke-linecap="round"/></svg>
          <h2 class="sec-title">ورودی‌ها</h2>
        </div>
        <div class="sec-body">
          <div class="inputs">
            <div><label for="S">S — سطح اشغال (m²)</label><div class="control"><input id="S" inputmode="decimal" placeholder="مثلاً 2500" /><span class="suffix">m²</span></div></div>
            <div><label for="D">D — عمق گود، Dmax (m)</label><div class="control"><input id="D" inputmode="decimal" placeholder="مثلاً 27" /><span class="suffix">m</span></div></div>
            <div><label for="B">B — عرض مؤثر سطح اشغال (m)</label><div class="control"><input id="B" inputmode="decimal" placeholder="مثلاً 22" /><span class="suffix">m</span></div></div>
            <div><label for="F">F — تعداد طبقات/سقف‌های سازه‌ای</label><div class="control"><input id="F" inputmode="numeric" placeholder="مثلاً 12" /><span class="suffix">طبقه</span></div></div>
          </div>
          <div class="row">
            <button id="calc" class="btn">محاسبه</button>
            <button id="reset" class="btn btn-outline">ریست</button>
            <span class="note">ارقام فارسی/ویرگول هم قابل قبول است (۱۲٬۳۴۵ → 12345).</span>
          </div>
          <div id="err" class="err">ورودی‌ها باید اعداد معتبر و غیرمنفی باشند.</div>
        </div>
      </section>

      <!-- Quick Results -->
      <section class="section sec-results">
        <div class="sec-header">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12l4 4L19 6" stroke="#065f46" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
          <h2 class="sec-title">نتایج سریع</h2>
        </div>
        <div class="sec-body">
          <div class="cards">
            <div class="card"><div class="k">عمق از تراز شروع حفاری</div><div class="v" id="v_start">–</div></div>
            <div class="card"><div class="k">عمق از تراز زیرِپی</div><div class="v" id="v_found">–</div></div>
            <div class="card"><div class="k">حداقل تعداد گمانه‌ها</div><div class="v" id="v_bh">–</div></div>
            <div class="card"><div class="k">حداقل تعداد چاهک گود</div><div class="v" id="v_hs">–</div></div>
            <div class="card"><div class="k">آزمایش برش برجا (تعداد)</div><div class="v" id="v_shear">–</div></div>
            <div class="card"><div class="k">آزمایش بارگذاری صفحه (تعداد)</div><div class="v" id="v_plate">–</div></div>
            <div class="card"><div class="k">دان‌هول (در صورت F≥11)</div><div class="v" id="v_dh">–</div></div>
          </div>
          <p class="note" style="margin-top:10px">
            الزام زیرجدول: حداقل یک گمانه باید <span class="chip">۳۰ متر زیرِ تراز فونداسیون</span> باشد.
            طرح عمق گمانه‌ها: <span id="planChip" class="chip">—</span>
          </p>
        </div>
      </section>
    </div>

    <!-- Data details -->
    <section class="section sec-table" style="margin-top:18px">
      <div class="sec-header">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 5h16v14H4zM8 5v14M16 5v14M4 9h16M4 15h16" stroke="#1d4ed8" stroke-width="1.8" fill="none" stroke-linecap="round"/></svg>
        <h2 class="sec-title">جزئیات داده‌ها</h2>
      </div>
      <div class="sec-body">
        <div class="table-wrap">
          <table>
            <thead><tr><th>شاخص</th><th>مقدار</th><th>توضیح</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>
    این محاسبه‌گر، توسط گروه <strong>رستا</strong> صرفاً بعنوان راهنما برای شرکت‌های خدمات آزمایشگاهی استان تهران تهیه شده است و
    وظیفه کنترل صحت و سقم اطلاعات بر عهده <strong>مسئول فنی شرکت</strong> می‌باشد.
  </footer>

  <script>
    /* Persian/Arabic digits → number */
    const fa=/[۰-۹]/g, ar=/[٠-٩]/g;
    const maps={fa:{'۰':0,'۱':1,'۲':2,'۳':3,'۴':4,'۵':5,'۶':6,'۷':7,'۸':8,'۹':9}, ar:{'٠':0,'١':1,'٢':2,'٣':3,'٤':4,'٥':5,'٦':6,'٧':7,'٨':8,'٩':9}};
    function toNumber(v){ if(v==null) return NaN; let s=String(v).trim().replace(/\s+/g,'').replace(/,/g,'').replace(/٬/g,''); s=s.replace(fa,d=>maps.fa[d]).replace(ar,d=>maps.ar[d]); return Number(s); }

    /* Core V7 */
    function kB(S){return (S<=300)?2:(S<=1000?1.5:1);}
    function N(S){return (S>1000)?2*Math.ceil((S-1000)/1000):0;}
    function M(D){return (D>20)?Math.ceil((D-20)/10):0;}
    function boreholes(S){return (S<=300?2:3)+N(S);}
    function handshafts(S,D){const n=N(S),m=M(D); if(S<=300){ if(D>10) return 2; return 1; } if(S<=1000){ if(D>20) return 3+m; if(D>10) return 3; return 2; } if(D>20) return 3+n+m; if(D>10) return 3+n; return 2+n;}
    function insitu(D){ if(D<7) return 0; if(D<=10) return 1; return 2; }
    function downhole(F,bh){ return (F>=11)?Math.ceil(bh/3):0; }

    /* Borehole depth plan: ensure ≥ (D + 30) from start for ≥1 BH */
    function depthPlanFromStart(baseDepth, count, thresholdFromStart){
      const arr=[]; for(let i=0;i<count;i++) arr.push(Number(baseDepth.toFixed(2)));
      if(count>0){ arr[0] = Number(Math.max(baseDepth, thresholdFromStart).toFixed(2)); }
      // summarize like "1×39 m، 2×27 m"
      const map=new Map();
      arr.forEach(d=>{const k=d.toFixed(2); map.set(k,(map.get(k)||0)+1);});
      const summary=[...map.entries()].sort((a,b)=>Number(b[0])-Number(a[0])).map(([k,c])=>`${c}×${Number(k)} m`).join('، ');
      const enforced = baseDepth < thresholdFromStart;
      return {arr, summary, enforced, thresholdFromStart: Number(thresholdFromStart.toFixed(2))};
    }

    const $=id=>document.getElementById(id);
    const inputs=['S','D','B','F'].map($);
    const els={start:$('v_start'), found:$('v_found'), bh:$('v_bh'), hs:$('v_hs'), shear:$('v_shear'), plate:$('v_plate'), dh:$('v_dh'), tb:$('tbody'), planChip:$('planChip')};

    function calc(){
      const S=toNumber($('S').value), D=toNumber($('D').value), B=toNumber($('B').value), F=toNumber($('F').value);
      if([S,D,B,F].some(x=>!isFinite(x)||x<0)) throw new Error("bad");
      const kb=kB(S);
      const startBase=Number((kb*B + D).toFixed(2));
      const found=Number((kb*B).toFixed(2));
      const bh=boreholes(S), hs=handshafts(S,D), t=insitu(D), dh=downhole(F,bh);
      const thresholdFromStart = D + 30; // ۳۰ متر زیر تراز فونداسیون
      const plan=depthPlanFromStart(startBase, bh, thresholdFromStart);
      return {S,D,B,F,kb,start:startBase,found,bh,hs,shear:t,plate:t,dh,N:N(S),M:M(D), plan};
    }

    function render(){
      try{
        const r=calc(); $('err').style.display='none';
        els.start.textContent=r.start+" m"; els.found.textContent=r.found+" m";
        els.bh.textContent=r.bh; els.hs.textContent=r.hs;
        els.shear.textContent=r.shear; els.plate.textContent=r.plate; els.dh.textContent=r.dh;
        els.planChip.textContent = r.plan.summary || '—';

        const rows=[
          ["kB", r.kb, "بر حسب S"],
          ["N",  r.N,  "هر ۱۰۰۰m² بالای ۱۰۰۰ ⇒ +۲ گمانه"],
          ["M",  r.M,  "هر ۱۰m بالای ۲۰ ⇒ +۱ چاهک"],
          ["عمق از تراز شروع حفاری (پایه)", r.start+" m", "kB×B + D"],
          ["عمق از تراز زیرِپی",           r.found+" m", "kB×B"],
          ["حداقل تعداد گمانه‌ها",         r.bh, "طبق جدول + N"],
          ["حداقل تعداد چاهک گود",         r.hs, "طبق جدول + M (در صورت D>20)"],
          ["آستانه الزام (از شروع حفاری)", r.plan.thresholdFromStart+" m", "D + 30 (۳۰ متر زیر تراز فونداسیون)"],
          ["طرح عمق گمانه‌ها",             r.plan.summary, r.plan.enforced ? "اعمال الزام: ≥1 گمانه = D+30" : "پایه ≥ D+30 بود؛ تغییری لازم نشد"],
          ["آزمایش برش برجا (تعداد)",      r.shear, "D<7→0 ، 7–10→1 ، >10→2"],
          ["آزمایش بارگذاری صفحه (تعداد)", r.plate, "همان شرط برش برجا"],
          ["دان‌هول (در صورت F≥11)",       r.dh, "ceil(گمانه/3)"]
        ];
        els.tb.innerHTML='';
        rows.forEach(rw=>{
          const tr=document.createElement('tr');
          rw.forEach(c=>{const td=document.createElement('td'); td.textContent=c; tr.appendChild(td);});
          els.tb.appendChild(tr);
        });
      }catch(e){ $('err').style.display='block'; }
    }

    $('calc').addEventListener('click', render);
    $('reset').addEventListener('click', ()=>{ inputs.forEach(i=>i.value=''); render(); });
    inputs.forEach(i=> i.addEventListener('input', render));
    render();
  </script>
</body>
</html>
